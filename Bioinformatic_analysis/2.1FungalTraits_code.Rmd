---
title: "Fungal Traits analysis of Navalacruz 2021 dataset sampling"
author: "Amara Santiesteban Serrano"
date: " r format(Sys.time(), '%d %B, %Y') "
output: 
  html_document:
    df_print: paged
    pdf_document: default
    word_document: default
  editor_options:
    chunk_output_type: inline
---

**FungalTraits**

```{r}
#install.packages("devtools")
#devtools::install_github("ropenscilabs/datastorr")
#devtools::install_github("traitecoevo/fungaltraits")
library(fungaltraits)
```

```{r Uploading FungalTraits database}
fungal_traits <- fungal_traits() #As we can see, the Genus column is clean. However in our dataset every genus name contains a "g__" as a prefix. In order to match both datasets we need to get rid of that prefix:
head(fungal_traits)
```

```{r}
vista <- fungal_traits %>%
  dplyr::filter(Genus=="Linnemannia")
```

```{r Collapse the fungal traits database}
#We want to have a unique row for each Genus. In order to achieve this, we calculate the most frequent value (the mode) for each Genus in terms of each variable:
moda <- function(x) {
  ux <- na.omit(unique(x))
  ux[which.max(tabulate(match(x, ux)))]
}

# Group by Genus: 
fungal_traits_mode <- fungal_traits %>%
  dplyr::group_by(Genus) %>%
  dplyr::summarise(across(everything(), moda), .groups = "drop")
#write.csv(fungal_traits_mode, "fungal_traits_collapsed_moda.csv")
```

```{r Merging databases}
ps1_genus_clean <- as.data.frame(tax_table(ps1_genus)) 
ps1_genus_clean$Genus <- gsub("^g__", "", ps1_genus_clean$Genus)

#Extraction of the abundance matrix
otu_mat_genus <- as.data.frame(as.matrix(otu_table(ps1_genus)))

identical(rownames(ps1_genus_clean), rownames(otu_mat_genus)) #Must be TRUE

# Combine ABUNDANCE AND TAXA dataframes by Genus
df_combined <- cbind(ps1_genus_clean, otu_mat_genus) # OR
# Make rownames explicit
df1 <- otu_mat_genus %>% rownames_to_column(var = "ASV_ID")
df2 <- ps1_genus_clean %>% rownames_to_column(var = "ASV_ID")
# Merge by ID
df_combined <- df1 %>% 
  left_join(df2, by = "ASV_ID")

# Combine this dataframe with the Fungal Traits one
df_traits_final <- df_combined %>%
  dplyr::left_join(
    fungal_traits_mode %>% dplyr::select(Genus, speciesMatched, confidence_fg, growth_form_fg, guild_fg, notes_fg, trophic_mode_fg),  
    by = "Genus"
  )
```

```{r}
vista <- df_traits_final %>%
  dplyr::filter(Genus=="Linnemannia")
```

```{r Evaluation of the confidence level}
asvs_by_confidence <- df_traits_final %>%
  dplyr::group_by(confidence_fg) %>%
  dplyr::summarise(n_ASVs = n_distinct(ASV_ID),
                   .groups = "drop") %>%
  dplyr::mutate(total_ASVs = n_total_asvs,
                perc_ASVs = round((n_ASVs / total_ASVs) * 100, 1)
  )
```

```{r % of matching}
# Matching Genus level
asvs_with_traits <- df_combined %>%
  dplyr::filter(!is.na(Genus)) %>%
  dplyr::filter(Genus %in% unique(fungal_traits_mode$Genus))

# Number of unique ASVs matching
n_matching_asvs <- n_distinct(asvs_with_traits$ASV_ID)
n_total_asvs <- n_distinct(df_combined$ASV_ID)

cat("Number of ASVs matching with FungalTraits:", n_matching_asvs, "\n")
cat("Number of total ASVs:", n_total_asvs, "\n")

# Sum of reads matching Genus level traits
reads_matching <- asvs_with_traits %>%
  dplyr::select(-ASV_ID, -Kingdom, -Phylum, -Class, -Order, -Family, -Genus, -Species) %>%   
  as.matrix() %>%
  sum(na.rm = TRUE)

# Total reads in dataset
total_reads <- df_combined %>%
  dplyr::select(-ASV_ID, -Kingdom, -Phylum, -Class, -Order, -Family, -Genus, -Species) %>%
  as.matrix() %>%
  sum(na.rm = TRUE)

cat("Number of reads matching with FungalTraits:", reads_matching, "\n")
cat("Total number of reads:", total_reads, "\n")

# 42.2% of taxonomic assignment by Genus

###reads/abundance####
# Total abundance (reads) matching
matching_reads <- sum(asvs_with_traits$Abundance, na.rm = TRUE)

# Total reads in dataset
total_reads <- sum(ps1_genus_melted$Abundance, na.rm = TRUE)

# Print results
cat("Total reads matching with FungalTraits:", matching_reads, "\n")
cat("Total reads in dataset:", total_reads, "\n")
cat("Percentage of matching reads:", matching_reads / total_reads * 100, "%\n") #This means that the 42% of ASVs matched with the fungal traits database actually represents 80% of the most abundant ASVs (fungal traits does not have info for our less abundant ASV, which is ok)
```

```{r Guild richness}
# Integrate df_traits_final with metadata
df_long <- df_traits_final %>%
  pivot_longer(
    cols = matches("-FIREFUNGI$"),  
    names_to = "SampleID",
    values_to = "Abundance"
  ) 

ps1_genus_metadata <- as(sample_data(ps1_genus), "data.frame") #With phyloseq objects this is the only way to turn this into a dataframe
ps1_genus_metadata$SampleID <- rownames(ps1_genus_metadata)

df_long_meta <- df_long %>%
  dplyr::left_join(ps1_genus_metadata %>% 
  dplyr::select(SampleID, PLOT, SITE, TRAT2, DEPTH), by = "SampleID")

### DOES GUILD RICHNESS VARY ACROSS FIRE SEVERITY AND DEPTH? We need a richness number per sample (must include SampleID)
richness_guild_df <- df_long_meta %>%
  dplyr::group_by(SampleID, SITE, TRAT2, DEPTH) %>%
  dplyr::summarise(Richness = n_distinct(guild_fg), .groups = "drop")

richness_guild_df$DEPTH <- ordered(richness_guild_df$DEPTH, levels=c("topsoil", "subsoil"))

ggplot(richness_guild_df, aes(x = TRAT2, y = Richness, fill = TRAT2, color=TRAT2)) +
  geom_jitter(width = 0.2, size = 2) +
  geom_boxplot(alpha = 0.3) +
  scale_fill_manual(values = c("#1d91c0","#feb24c","#cb181d","#800026")) +
  scale_color_manual(values = c("#1d91c0","#feb24c","#cb181d","#800026")) +
  labs(
    x = "Fire severity",
    y = "Nº unique guilds"
  ) +
  theme_minimal()+
  theme(
    panel.background = element_blank(),
    panel.border = element_rect(colour = "black", fill = NA),
    panel.grid = element_blank(),
    axis.text.x = element_text(size = 14),  # Change this value as needed
    axis.text.y = element_text(size = 14),
    legend.position = "none"
  ) +
  facet_wrap(~DEPTH, scales="free_x")
#ggsave("functional_guild_richness.png")

hist(richness_guild_df$Richness)
leveneTest(Richness ~ TRAT2 * DEPTH, data = richness_guild_df) #We can assume homogeneity of variance
# If assumptions met → 2-way ANOVA:
rich_aov <- aov(Richness ~ TRAT2 * DEPTH, data = richness_guild_df)
summary(rich_aov)

rich_lmer <- lmer(Richness ~ TRAT2 * DEPTH + (1|SITE), data = richness_guild_df)
anova(rich_lmer)
```

```{r Relative guild abundance per fire severity}
## First: relative abundance per sample
df_rel <- df_long_meta %>%
  dplyr::group_by(SampleID) %>%
  dplyr::mutate(RelAbund = Abundance / sum(Abundance)) %>%
  dplyr::ungroup()

df_rel %>% ## Just to make sure the sum of rel abundances per sample = 1
  dplyr::group_by(SampleID) %>%
  dplyr::summarise(Suma_rel = sum(RelAbund))

## Relative abundance per guild per sample
guild_rel <- df_rel %>%
  dplyr::group_by(SampleID, TRAT2, DEPTH, guild_fg) %>%
  dplyr::summarise(RelAbund = sum(RelAbund), .groups = "drop") 

guild_rel %>% ## Just to make sure the sum of rel abundances per guild per sample = 1
  dplyr::group_by(SampleID) %>%
  dplyr::summarise(Suma_rel = sum(RelAbund))

## Summarise to graph
guild_rel_summary <- guild_rel %>%
  dplyr::group_by(TRAT2, DEPTH, guild_fg) %>%
  dplyr::summarise(MeanRelAbund = mean(RelAbund)*100,
                   se = sd(RelAbund)/sqrt(n())*100,
                   .groups = "drop") 
#guild_rel_summary %>%  #Normalize each mean within each treatment/depth to make sure in the graph each bar adds to 1
#  dplyr::group_by(TRAT2, DEPTH) %>%
#  dplyr::mutate(graph_abun = MeanRelAbund / sum(MeanRelAbund))

guild_rel_summary2 <- guild_rel_summary %>%
  dplyr::group_by(TRAT2, DEPTH) %>%
  dplyr::mutate(guild_fg = ifelse(graph_abun < 0.05, "Other", as.character(guild_fg))) %>%
  ungroup()

guild_rel_summary2$TRAT2 <- ordered(guild_rel_summary2$TRAT2, levels = c("UB", "LS", "HS1", "HS2"))
guild_rel_summary2$DEPTH <- ordered(guild_rel_summary2$DEPTH, levels = c("topsoil", "subsoil"))

mine <- c("#DD1C77",
          "#C994C7", 
          "#a1d99b",
          "#9ecae1",
          "#edf8b1", 
          "#2c7fb8", 
          "#7F3980")

ggplot(guild_rel_summary2, aes(x = TRAT2, y = graph_abun, fill = guild_fg)) +
  geom_col(position = "stack") +
  coord_flip() +
  facet_wrap(~DEPTH, nrow = 1) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  #scale_fill_brewer(name = "Fungal guild", palette = "Dark2", na.value = "grey50")+
  #scale_fill_viridis_d(name = "Fungal guild", option = "D", na.value = "grey50", direction = -1) +
  scale_fill_manual(values=mine, na.value = "grey70") +
  labs(
    x = "Fire severity treatment",
    y = "Mean relative abundance (%)",
    title = "Relative abundance of fungal guilds by fire severity and soil depth"
  ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(),
    strip.background = element_blank(),  # Remove strip background
    axis.text.x = element_text(angle = 0.1, hjust = 1),  # Rotate x-axis labels
    panel.background = element_blank(),  # Remove panel background color
    plot.background = element_blank(),   # Remove plot background color
    #legend.position = "none"             # Remove legend
  )
#ggsave("stacked_guilds.png")
```

```{r}
vista <- df_rel %>% dplyr::filter(Genus=="Tomentella")
```

```{r DOES RELATIVE ABUNDANCE DIFFER BY SEVERITY AND DEPTH?}

guild_rel_TOP <- guild_rel %>% dplyr::filter(DEPTH=="topsoil")
guild_rel_SUB <- guild_rel %>% dplyr::filter(DEPTH=="subsoil")

lm_results <- lm(RelAbund ~ TRAT2, data = guild_rel_TOP %>% dplyr::filter(guild_fg=="Wood Saprotroph")) 
anova(lm_results)
emm <- emmeans(lm_results, pairwise ~ TRAT2)

cld_results <- cld(emm$emmeans, Letters = letters)
cld_results
```

################################################################################

```{r Paleta Neón}
n_colors <- length(unique(ps1melted_traits_clean$guild_fg))
neon_palette <- createPalette(n_colors, seedcolors = c("#FF00FF","#39FF14", "#FF6EC7", "#00FFFF","#FFFF00"), range = c(40, 100))


# Asignar nombres si quieres reproducibilidad
names(neon_palette) <- unique(ps1melted_traits_clean$guild_fg)
```

```{r Visualization: Trophic mode}
ps1melted_traits_clean <- ps1melted_traits %>%
  filter(!is.na(growth_form_fg)) #Keep only entries with values in the column 'guild_fg'

ps1melted_traits_clean$DEPTH <- factor(ps1melted_traits_clean$DEPTH, levels = c("topsoil", "subsoil"))

ps1melted_traits_clean %>%
  dplyr::group_by(Sample, guild_fg, TRAT2, DEPTH) %>%
  dplyr::summarise(RelAbun = sum(Abundance)/n(), .groups = "drop") %>%
  ggplot(aes(x = guild_fg, y = RelAbun, fill = guild_fg)) +
  geom_boxplot(width = 0.6, outlier.size = 0.8, alpha = 0.8) +
  #scale_y_log10() + #Log-transform the TotalAbundance for better visualization
  scale_fill_manual(values = neon_palette) +  
  facet_grid(DEPTH ~ TRAT2, scales = "free_y") +
  theme_bw() +
  theme(
    axis.text.x = element_blank(),  # quitar etiquetas del eje x
    axis.ticks.x = element_blank(),
    panel.grid = element_blank(),
    strip.text = element_text(size = 12),
    legend.position = "bottom",  
    legend.title = element_blank()
  ) +
  labs(x = NULL, y = "Relative Abundance")
#ggsave("FungalTraits_TrophicRelAbun.png")
```

```{r Visualization: Symbiotrophs}
ps1melted_traits_clean <- ps1melted_traits %>%
  filter(!is.na(trophic_mode_fg == "Pathotroph-Symbiotroph"))

ps1melted_traits_clean %>%
  dplyr::filter(trophic_mode_fg == "Pathotroph-Symbiotroph") %>%
  dplyr::group_by(Sample, growth_form_fg, TRAT2, DEPTH) %>%
  dplyr::summarise(TotalAbund = sum(Abundance), .groups = "drop") %>%
  ggplot(aes(x = growth_form_fg, y = TotalAbund, fill = growth_form_fg)) +
  geom_boxplot(width = 0.6, outlier.size = 0.8, alpha = 0.8) +
  scale_y_log10()+
  scale_fill_brewer(palette = "Set2") +
  facet_grid(DEPTH ~ TRAT2) +
  theme_bw() +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    panel.grid = element_blank(),
    strip.text = element_text(size = 12),
    #legend.position = "none"
  ) +
  labs(x = NULL, y = "Total abundance of symbiotrophs")
#ggsave("FungalTraits_SymbioForm.png")
```

```{r Trophic summary}
trophic_summary <- ps1melted_traits %>%
  dplyr::group_by(guild_fg) %>%
  dplyr::summarise(total_abundance = sum(Abundance))

# Calculate percentage
trophic_summary <- trophic_summary %>%
  dplyr::mutate(percent = 100 * total_abundance / sum(total_abundance))

ps1melted_traits %>%
  dplyr::group_by(TRAT2, guild_fg) %>%
  dplyr::summarise(Abundance = sum(Abundance), .groups = "drop") %>%
  dplyr::group_by(TRAT2) %>%
  dplyr::mutate(Total = sum(Abundance),
         Percent = 100 * Abundance / Total)

```


```{r Visualization: Pathotrophs}
ps1melted_traits_clean %>%
  dplyr::filter(trophic_mode_fg == "Pathotroph") %>%
  dplyr::group_by(Sample, growth_form_fg, TRAT2, DEPTH) %>%
  dplyr::summarise(TotalAbund = sum(Abundance), .groups = "drop") %>%
  ggplot(aes(x = growth_form_fg, y = TotalAbund, fill = growth_form_fg)) +
  geom_boxplot(width = 0.6, outlier.size = 0.8, alpha = 0.8) +
  #scale_y_log10() +
  scale_fill_brewer(palette = "Set2") +
  facet_grid(DEPTH ~ TRAT2) +
  theme_bw() +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    panel.grid = element_blank(),
    strip.text = element_text(size = 12),
    #legend.position = "none"
  ) +
  labs(x = NULL, y = "Total abundance of symbiotrophs")
#ggsave("FungalTraits_PathoForm.png")
```


